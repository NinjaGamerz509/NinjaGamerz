// server.js
const express = require("express");
const multer = require("multer");
const path = require("path");
const fs = require("fs");

const app = express();

// ==== CONFIG ====
const UPLOAD_DIR = path.join(__dirname, "uploads");
if (!fs.existsSync(UPLOAD_DIR)) fs.mkdirSync(UPLOAD_DIR);

const ADMIN_PASS = "Ninja786"; // ⚠️ Simple password

// Allowed extensions (NO images/videos)
const ALLOWED_EXT = new Set([
  ".zip", ".jar", ".sk", ".txt", ".json",
  ".yml", ".yaml", ".mcpack", ".mcmeta",
  ".rar", ".7z", ".phar"
]);

// ==== MULTER STORAGE ====
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, UPLOAD_DIR),
  filename: (req, file, cb) => {
    const safe = file.originalname.replace(/\s+/g, "_");
    cb(null, Date.now() + "-" + safe);
  }
});

const upload = multer({
  storage,
  limits: { fileSize: 50 * 1024 * 1024 }, // 50MB
  fileFilter: (req, file, cb) => {
    const ext = path.extname(file.originalname).toLowerCase();
    if (!ALLOWED_EXT.has(ext)) return cb(new Error("File type not allowed"));
    if (file.mimetype.startsWith("image/") || file.mimetype.startsWith("video/")) {
      return cb(new Error("Images/videos not allowed"));
    }
    cb(null, true);
  }
}).single("file");

// ==== ROUTES ====

// Serve uploads
app.use("/uploads", express.static(UPLOAD_DIR));

// List files
app.get("/files", (req, res) => {
  fs.readdir(UPLOAD_DIR, (err, files) => {
    if (err) return res.json([]);
    const list = files.map(fn => {
      const stat = fs.statSync(path.join(UPLOAD_DIR, fn));
      return {
        name: fn.split("-").slice(1).join("-") || fn,
        url: "/uploads/" + encodeURIComponent(fn),
        uploadedAt: stat.mtimeMs
      };
    }).sort((a, b) => b.uploadedAt - a.uploadedAt);
    res.json(list);
  });
});

// Upload endpoint
app.post("/upload", (req, res) => {
  upload(req, res, err => {
    if (err) return res.status(400).json({ success: false, message: err.message });
    if (req.body.adminPass !== ADMIN_PASS) {
      if (req.file) fs.unlink(req.file.path, () => {});
      return res.status(401).json({ success: false, message: "Wrong password" });
    }
    if (!req.file) return res.status(400).json({ success: false, message: "No file" });
    res.json({ success: true });
  });
});

// ==== FRONTEND HTML ====
app.get("/", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>𝙽𝙸𝙽𝙹𝙰𝙂𝙰𝙼𝙴𝚁𝚉</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#000;color:#1E90FF;text-align:center;}
header{padding:15px;background:#111;position:sticky;top:0;z-index:10;}
h1{margin:0;font-size:2rem;}
section{padding:30px;margin:20px auto;max-width:900px;background:rgba(20,20,20,.85);border-radius:12px;}
.card{background:#222;padding:12px;border-radius:8px;margin:10px;}
.platform-btn{padding:8px 12px;border-radius:8px;background:#1E90FF;color:#fff;text-decoration:none;display:inline-block;}
#adminModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:20;}
#adminModal .box{background:#111;padding:20px;border-radius:10px;width:90%;max-width:400px;}
</style>
</head>
<body>
<header><h1>𝙽𝙸𝙽𝙹𝙰𝙶𝙰𝙼𝙴𝚁𝚉</h1></header>

<section id="freeStuff">
  <h2>Free Stuff</h2>
  <div id="freeList">Loading...</div>
  <p><button id="openAdminBtn" class="platform-btn">Admin Upload</button></p>
</section>

<div id="adminModal">
  <div class="box">
    <h3>Admin Upload</h3>
    <form id="uploadForm">
      <input type="password" id="adminPass" placeholder="Password" required style="width:100%;margin:6px 0;padding:6px;" />
      <input type="file" id="fileInput" required style="width:100%;margin:6px 0;" />
      <p><button type="submit" class="platform-btn">Upload</button>
         <button type="button" id="closeAdmin" class="platform-btn" style="background:#444;">Cancel</button></p>
      <p id="uploadMsg"></p>
    </form>
  </div>
</div>

<script>
async function loadFiles(){
  const list=document.getElementById("freeList");
  list.innerHTML="Loading...";
  try{
    const res=await fetch("/files");
    const files=await res.json();
    if(!files.length){list.innerHTML="<div class='card'>No files yet.</div>";return;}
    list.innerHTML="";
    files.forEach(f=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=\`<h4>\${f.name}</h4>
      <a href="\${f.url}" download class="platform-btn">⬇️ Download</a>\`;
      list.appendChild(div);
    });
  }catch{list.innerHTML="Error loading files";}
}
loadFiles();

document.getElementById("openAdminBtn").onclick=()=>document.getElementById("adminModal").style.display="flex";
document.getElementById("closeAdmin").onclick=()=>{document.getElementById("adminModal").style.display="none";};

document.getElementById("uploadForm").onsubmit=async e=>{
  e.preventDefault();
  const msg=document.getElementById("uploadMsg");
  msg.textContent="Uploading...";
  const fd=new FormData();
  fd.append("adminPass",document.getElementById("adminPass").value);
  fd.append("file",document.getElementById("fileInput").files[0]);
  try{
    const res=await fetch("/upload",{method:"POST",body:fd});
    const data=await res.json();
    if(res.ok){
      msg.textContent="Upload successful!";
      await loadFiles();
      setTimeout(()=>document.getElementById("adminModal").style.display="none",800);
    }else msg.textContent=data.message;
  }catch{msg.textContent="Upload failed";}
};
</script>

</body>
</html>
  `);
});

// ==== START ====
const PORT = process.env.PORT || 3000;
app.listen(PORT, ()=> console.log("Running on http://localhost:"+PORT));
